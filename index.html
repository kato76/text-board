<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>見守り文字ボード</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: black;
  color: white;
  font-family: "Meiryo", sans-serif;
}

#container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

#text {
  font-size: 8vw;
  text-align: center;
  padding: 3vw;
  line-height: 1.4;
  white-space: pre-wrap;
}

#status {
  position: fixed;
  bottom: 10px;
  right: 10px;
  font-size: 14px;
  color: #0f0;
  opacity: 0.8;
}
</style>
</head>

<body>

<div id="container">
  <div id="text">画面を一度タップしてください</div>
</div>
<div id="status">未開始</div>

<!-- ============================= -->
<!-- 無音ループ（OSキープ用） -->
<!-- ============================= -->
<audio id="keepalive" loop>
  <!-- 超短・無音WAV -->
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

<script>
/* ============================= */
/* 音声認識 初期化 */
/* ============================= */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const textEl   = document.getElementById("text");
const statusEl = document.getElementById("status");
const keepalive = document.getElementById("keepalive");

if (!SpeechRecognition) {
  textEl.innerText = "この端末は音声認識に対応していません";
  throw new Error("SpeechRecognition not supported");
}

let recognition = null;
let recognizing = false;
let lastResultTime = Date.now();

/* ============================= */
/* 音声認識 作成 */
/* ============================= */
function createRecognition() {
  const r = new SpeechRecognition();
  r.lang = "ja-JP";
  r.continuous = true;
  r.interimResults = false;

  r.onresult = (event) => {
    lastResultTime = Date.now();
    const txt = event.results[event.results.length - 1][0].transcript;
    textEl.innerText = txt;
    statusEl.innerText = "認識中";
  };

  r.onerror = (e) => {
    console.log("speech error:", e.error);
    recognizing = false;
    statusEl.innerText = "エラー";
  };

  r.onend = () => {
    recognizing = false;
    statusEl.innerText = "停止 → 再起動待ち";
  };

  return r;
}

/* ============================= */
/* 開始処理 */
/* ============================= */
function startRecognition() {
  if (recognizing) return;

  if (recognition) {
    try { recognition.stop(); } catch(e) {}
    recognition = null;
  }

  recognition = createRecognition();

  try {
    // 無音ループ開始（最重要）
    keepalive.volume = 0.001;
    keepalive.play().catch(()=>{});

    recognition.start();
    recognizing = true;
    statusEl.innerText = "待機中";
  } catch (e) {
    console.warn("start failed");
  }
}

/* ============================= */
/* 初回ユーザー操作（必須） */
/* ============================= */
document.body.addEventListener("click", () => {
  textEl.innerText = "聞き取り中…";
  startRecognition();
}, { once: true });

/* ============================= */
/* マイク完全死亡監視（②） */
/* ============================= */
setInterval(() => {
  const now = Date.now();

  // 認識中なのに長時間結果ゼロ → 死亡疑い
  if (recognizing && now - lastResultTime > 60000) {
    console.log("mic dead suspected");
    recognizing = false;

    textEl.innerText = "画面をタップしてください";
    statusEl.innerText = "マイク停止";

    try {
      recognition.stop();
    } catch(e) {}
  }

  // 復帰可能なら自動再開
  if (!recognizing && document.visibilityState === "visible") {
    startRecognition();
  }

}, 15000);

/* ============================= */
/* 画面復帰対策 */
/* ============================= */
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    statusEl.innerText = "復帰中";
    startRecognition();
  }
});
</script>

</body>
</html>
