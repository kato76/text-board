<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>見守り文字ボード</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: black;
  color: white;
  font-family: "Meiryo", sans-serif;
}

#container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

#text {
  font-size: 8vw;
  text-align: center;
  padding: 3vw;
  line-height: 1.4;
  white-space: pre-wrap;
}

#status {
  position: fixed;
  bottom: 10px;
  right: 10px;
  font-size: 14px;
  color: #0f0;
}
</style>
</head>

<body>

<div id="container">
  <div id="text">画面を一度タップしてください</div>
</div>
<div id="status">未開始</div>

<!-- 無音ループ -->
<audio id="keepalive" loop>
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

<script>
/* ============================
   スプレッドシート設定
============================ */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/【←あなたのURL】/pub?gid=0&single=true&output=csv";

const REMOTE_SEC = 40;

/* ============================
   共通DOM
============================ */
const textEl   = document.getElementById("text");
const statusEl = document.getElementById("status");
const keepalive = document.getElementById("keepalive");

/* ============================
   スプレッドシート監視
============================ */
let lastSheetText = "";

async function checkSheet() {
  try {
    const res = await fetch(SHEET_URL + "&_=" + Date.now());
    const txt = (await res.text()).trim();

    if (txt && txt !== lastSheetText) {
      lastSheetText = txt;
      textEl.innerText = txt;
      statusEl.innerText = "シート表示中";

      setTimeout(() => {
        statusEl.innerText = "待機中";
      }, REMOTE_SEC * 1000);
    }
  } catch (e) {
    console.log("sheet error");
  }
}

setInterval(checkSheet, 5000);

/* ============================
   音声認識
============================ */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  textEl.innerText = "音声認識非対応端末";
  throw new Error();
}

let recognition = null;
let recognizing = false;
let lastResultTime = Date.now();

function createRecognition() {
  const r = new SpeechRecognition();
  r.lang = "ja-JP";
  r.continuous = true;
  r.interimResults = false;

  r.onresult = (e) => {
    lastResultTime = Date.now();
    const t = e.results[e.results.length - 1][0].transcript;
    textEl.innerText = t;
    statusEl.innerText = "音声認識中";
  };

  r.onerror = () => recognizing = false;
  r.onend   = () => recognizing = false;

  return r;
}

function startRecognition() {
  if (recognizing) return;

  recognition = createRecognition();

  try {
    keepalive.volume = 0.001;
    keepalive.play().catch(()=>{});
    recognition.start();
    recognizing = true;
    statusEl.innerText = "待機中";
  } catch(e) {}
}

document.body.addEventListener("click", () => {
  textEl.innerText = "聞き取り中…";
  startRecognition();
}, { once:true });

/* ============================
   マイク死亡監視
============================ */
setInterval(() => {
  const now = Date.now();

  if (recognizing && now - lastResultTime > 60000) {
    recognizing = false;
    textEl.innerText = "画面をタップしてください";
    statusEl.innerText = "マイク停止";
    try { recognition.stop(); } catch(e){}
  }

  if (!recognizing && document.visibilityState === "visible") {
    startRecognition();
  }
}, 15000);
</script>

</body>
</html>
