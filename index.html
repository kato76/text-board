<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è¦‹å®ˆã‚Šæ–‡å­—ãƒœãƒ¼ãƒ‰</title>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: sans-serif;
}
#text {
  font-size: 6vw;
  margin-top: 30vh;
  text-align: center;
}
#status {
  position: fixed;
  bottom: 10px;
  width: 100%;
  font-size: 2.5vw;
  color: #0f0;
  text-align: center;
}
#mic {
  position: fixed;
  top: 10px;
  right: 20px;
  font-size: 3vw;
}
</style>
</head>

<body>
<div id="mic">ðŸŽ¤</div>
<div id="text">å¾…æ©Ÿä¸­</div>
<div id="status">èµ·å‹•ä¸­</div>

<script>
let lastTime = "";   // â† Cåˆ—ï¼ˆæ™‚åˆ»ï¼‰ã ã‘ã§æ›´æ–°åˆ¤å®š
let recognition;

/* ===== ã‚·ãƒ¼ãƒˆç›£è¦–ï¼ˆãƒžã‚¤ã‚¯ã¨å®Œå…¨åˆ†é›¢ï¼‰===== */
function pollSheet() {
  google.script.run.withSuccessHandler(data => {
    if (!data) return;

    // Cåˆ—ãŒå¤‰ã‚ã£ãŸã‚‰ã€Œæ›´æ–°ã•ã‚ŒãŸã€ã¨åˆ¤æ–­
    if (data.time && data.time !== lastTime) {
      lastTime = data.time;

      // Aåˆ—ã¯ç©ºã§ã‚‚ãã®ã¾ã¾è¡¨ç¤ºï¼ˆæ¶ˆã•ãªã„ï¼‰
      if (data.text !== "") {
        document.getElementById("text").innerText = data.text;
      }

      document.getElementById("status").innerText =
        "æ›´æ–°ï¼š" + data.time;
    }
  }).getSheetData();
}

// â˜… å¸¸ã«å‹•ã‹ã™ï¼ˆãƒžã‚¤ã‚¯çŠ¶æ…‹ã«é–¢ä¿‚ãªã—ï¼‰
setInterval(pollSheet, 3000);

/* ===== ãƒžã‚¤ã‚¯ï¼ˆå¸¸æ™‚å†èµ·å‹•ï¼‰===== */
function startMic() {
  if (!('webkitSpeechRecognition' in window)) {
    document.getElementById("status").innerText = "éŸ³å£°èªè­˜éžå¯¾å¿œ";
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = () => {
    document.getElementById("mic").innerText = "ðŸŽ¤ ON";
  };

  recognition.onend = () => {
    document.getElementById("mic").innerText = "ðŸŽ¤ å†æŽ¥ç¶š";
    setTimeout(startMic, 500); // â˜…æ­¢ã¾ã‚‰ã›ãªã„
  };

  recognition.onerror = () => {
    recognition.stop();
  };

  recognition.onresult = (event) => {
    let text = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      text += event.results[i][0].transcript;
    }

    // ç„¡éŸ³æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆæ—¢å­˜è¡¨ç¤ºã‚’æ¶ˆã•ãªã„ï¼‰
    if (text.trim() !== "") {
      document.getElementById("text").innerText = text;
      document.getElementById("status").innerText = "ãƒžã‚¤ã‚¯å…¥åŠ›ä¸­";
    }
  };

  recognition.start();
}

startMic();
</script>
</body>
</html>
