<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¼šè©±ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ</title>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: sans-serif;
  text-align: center;
}

#status {
  font-size: 7vw;
  margin-top: 8vh;
}

#text {
  font-size: 6vw;
  margin: 6vh 4vw;
  word-break: break-word;
}
</style>
</head>
<body>

<div id="status">ğŸ¤ å¾…æ©Ÿä¸­</div>
<div id="text"></div>

<script>
/* ====== è¨­å®š ====== */
const GAS_URL =
"https://script.google.com/macros/s/AKfycbwCPJTgEG0W7tk_Y7Nj_w7UAftj-51jO1qwxrnZ_2zQI6wj46Vedb-npqgeowafIfzCmA/exec";

const DEVICE_NAME = "tablet-" + Math.floor(Math.random() * 10000);
const SILENCE_LIMIT = 3000; // ç„¡éŸ³ã¯å¿…ãš3ç§’ã§åˆ‡ã‚‹ï¼ˆ10ç§’é˜²æ­¢ï¼‰

/* ====== éŸ³å£°èªè­˜ ====== */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

const recognition = new SpeechRecognition();
recognition.lang = "ja-JP";
recognition.interimResults = false;
recognition.continuous = false;

let silenceTimer = null;
let recognizing = false;

/* ====== è¡¨ç¤º ====== */
function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}

/* ====== ç„¡éŸ³ç›£è¦–ï¼ˆå¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼‰ ====== */
function startSilenceTimer() {
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(() => {
    if (recognizing) {
      recognition.abort(); // â† ã“ã“ãŒé‡è¦
    }
  }, SILENCE_LIMIT);
}

/* ====== èªè­˜é–‹å§‹ ====== */
function startRecognition() {
  if (recognizing) return;

  try {
    recognition.start();
    recognizing = true;
    setStatus("ğŸ¤ èã„ã¦ã„ã¾ã™â€¦");
    startSilenceTimer();
  } catch (e) {}
}

/* ====== çµæœå–å¾— ====== */
recognition.onresult = (event) => {
  clearTimeout(silenceTimer);
  recognizing = false;

  const text = event.results[0][0].transcript.trim();

  if (!text) {
    restart();
    return;
  }

  document.getElementById("text").innerText = text;
  setStatus("ğŸ“¤ è¨˜éŒ²ä¸­â€¦");

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({
      text: text,
      device: DEVICE_NAME
    })
  })
  .finally(() => {
    setTimeout(() => {
      restart();
    }, 800);
  });
};

/* ====== çµ‚äº†ãƒ»ã‚¨ãƒ©ãƒ¼ ====== */
recognition.onend = () => {
  recognizing = false;
  restart();
};

recognition.onerror = () => {
  recognizing = false;
  restart();
};

/* ====== å†å¾…æ©Ÿ ====== */
function restart() {
  setStatus("ğŸ¤ å¾…æ©Ÿä¸­");
  clearTimeout(silenceTimer);
  setTimeout(startRecognition, 500);
}

/* ====== èµ·å‹• ====== */
setTimeout(startRecognition, 1000);
</script>

</body>
</html>
