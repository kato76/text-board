<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦‹å®ˆã‚Šæ–‡å­—ãƒœãƒ¼ãƒ‰</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: sans-serif;
    }
    #start {
      width: 100vw;
      height: 100vh;
      font-size: 8vw;
      background: black;
      color: white;
      border: none;
    }
    #text {
      display: none;
      width: 100vw;
      height: 100vh;
      font-size: 6vw;
      text-align: center;
      padding: 5vw;
      line-height: 1.2;
      white-space: pre-wrap;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>

  <button id="start">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</button>
  <div id="text"></div>

  <audio id="keepalive" loop>
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
  </audio>

  <script>
    /* ==== è¨­å®š ==== */
    const POST_URL = "https://script.google.com/macros/s/AKfycbzsHCz4B1ndeweHQtaIKE14DSxCn65AVnwxvzO7OTduEcd4mh52JALvA3SYSzAxAsDLBQ/exec";
    const GET_URL  = "https://script.google.com/macros/s/AKfycbzNHg6HDMsCaT_OlPssMzjsgi_PIM5il7PePr4rLQw1RCVHZTQVZ967YDkZDLeQnocWuw/exec";

    const MIC_SEC = 30; // ãƒã‚¤ã‚¯å†è¡¨ç¤ºå¾…ã¡æ™‚é–“ï¼ˆç§’ï¼‰

    /* ==== çŠ¶æ…‹å¤‰æ•° ==== */
    let lastRow = -1;
    let lastSheetText = "";
    let recognition = null;
    let micTimer = null;
    let micPaused = false;

    const t = document.getElementById("text");
    const keepalive = document.getElementById("keepalive");

    /* ==== åˆå›èµ·å‹• ==== */
    document.getElementById("start").onclick = () => {
      document.getElementById("start").style.display = "none";
      t.style.display = "flex";
      t.innerText = "å¾…æ©Ÿä¸­";
      startMic();
      pollSheet();
    };

    /* ==== è¡¨ç¤ºå‡¦ç† ==== */
    function showText(msg) {
      if (!msg) return;
      t.innerText = msg;

      if (msg.length <= 20) t.style.fontSize = "12vw";
      else if (msg.length <= 40) t.style.fontSize = "10vw";
      else if (msg.length <= 80) t.style.fontSize = "8vw";
      else t.style.fontSize = "6vw";
    }

    /* ==== ãƒã‚¤ã‚¯ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ ==== */
    function pauseMic() {
      if (recognition && !micPaused) {
        recognition.stop();
        micPaused = true;
      }
    }

    function resumeMic() {
      if (micPaused) {
        startMic();  // å†åˆæœŸåŒ–
      }
    }

    /* ==== Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç›£è¦– ==== */
    async function pollSheet() {
      try {
        const res = await fetch(GET_URL + "?t=" + Date.now());
        const data = await res.json();

        if (data.row > lastRow || data.text !== lastSheetText) {
          lastRow = data.row;
          lastSheetText = data.text;

          pauseMic();                // ğŸ”´ ãƒã‚¤ã‚¯ä¸€æ™‚åœæ­¢
          showText(lastSheetText);   // è¡¨ç¤ºæ›´æ–°

          setTimeout(() => {
            resumeMic();             // ğŸ”µ ãƒã‚¤ã‚¯å†é–‹
          }, 5000); // 5ç§’é–“ã¯è¡¨ç¤ºã‚’ã‚­ãƒ¼ãƒ—
        }
      } catch (e) {}

      setTimeout(pollSheet, 500);
    }

    /* ==== ç™ºè©±é€ä¿¡ ==== */
    function sendToSheet(text) {
      fetch(POST_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
    }

    /* ==== ãƒã‚¤ã‚¯é–‹å§‹å‡¦ç† ==== */
    function startMic() {
      const S = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!S) return;

      recognition = new S();
      recognition.lang = "ja-JP";
      recognition.continuous = true;
      micPaused = false;

      recognition.onresult = (e) => {
        const text = e.results[e.results.length - 1][0].transcript.trim();
        if (!text) return;

        showText(text);
        sendToSheet(text);

        if (micTimer) clearTimeout(micTimer);
        micTimer = setTimeout(() => {
          micTimer = null;
          if (lastSheetText) showText(lastSheetText);
        }, MIC_SEC * 1000);
      };

      recognition.onend = () => {
        if (!micPaused) {
          setTimeout(startMic, 500);
        }
      };

      keepalive.volume = 0.001;
      keepalive.play().catch(() => {});
      recognition.start();
    }
  </script>

</body>
</html>
